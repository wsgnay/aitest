<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è§†é¢‘è·Ÿè¸ª - æ— äººæœºæ£€æµ‹ç³»ç»Ÿ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    .video-preview {
      background: #f8f9fa;
      border: 2px dashed #dee2e6;
      border-radius: 8px;
      padding: 2rem;
      text-align: center;
      min-height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }

    .video-preview.active {
      border-color: #0d6efd;
      background: #e7f3ff;
    }

    .video-stream {
      width: 100%;
      height: auto;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .detection-overlay {
      position: relative;
      display: inline-block;
    }

    .detection-info {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 0.9em;
    }

    .stream-controls {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 1rem;
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
    }

    .status-stopped { background: #6c757d; }
    .status-connecting { background: #ffc107; animation: pulse 1.5s infinite; }
    .status-active { background: #198754; }
    .status-error { background: #dc3545; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .log-container {
      height: 300px;
      overflow-y: auto;
      background: #f8f9fa;
      border-radius: 8px;
      padding: 1rem;
      font-family: monospace;
      font-size: 0.9em;
    }

    .log-entry {
      margin-bottom: 4px;
      padding: 2px 0;
    }

    .log-success { color: #198754; }
    .log-error { color: #dc3545; }
    .log-warning { color: #fd7e14; }
    .log-info { color: #0d6efd; }

    .detection-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
    }

    .stat-card {
      text-align: center;
      padding: 1rem;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: #0d6efd;
    }

    .stat-label {
      color: #6c757d;
      font-size: 0.9em;
    }

    .stream-url-input {
      font-family: monospace;
    }

    .preset-urls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .preset-url {
      font-size: 0.8em;
      padding: 0.25rem 0.5rem;
    }

    .camera-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }

    .camera-card {
      border: 1px solid #dee2e6;
      border-radius: 8px;
      overflow: hidden;
    }

    .camera-preview {
      width: 100%;
      height: 200px;
      background: #f8f9fa;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>
<body>
<div class="container-fluid mt-3">
  <!-- é¡µé¢æ ‡é¢˜ -->
  <div class="row mb-4">
    <div class="col">
      <h2>
        <i class="bi bi-camera-video me-2"></i>è§†é¢‘è·Ÿè¸ª
        <small class="text-muted">å®æ—¶è§†é¢‘æµæ£€æµ‹ä¸è·Ÿè¸ª</small>
      </h2>
    </div>
    <div class="col-auto">
      <button class="btn btn-outline-secondary" onclick="goBack()">
        <i class="bi bi-arrow-left me-1"></i>è¿”å›ä¸»é¡µ
      </button>
    </div>
  </div>

  <div class="row">
    <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="bi bi-gear me-2"></i>æµé…ç½®
          </h5>
        </div>
        <div class="card-body">
          <!-- è§†é¢‘æºé…ç½® -->
          <div class="mb-3">
            <label for="streamUrl" class="form-label">
              <i class="bi bi-link-45deg me-1"></i>è§†é¢‘æº
            </label>
            <input type="text" class="form-control stream-url-input" id="streamUrl"
                   placeholder="è¾“å…¥RTSP/RTMP/HTTPæµåœ°å€æˆ–æ‘„åƒå¤´ID">
            <div class="preset-urls">
              <button class="btn btn-outline-primary btn-sm preset-url" onclick="setPresetUrl('0')">
                æ‘„åƒå¤´0
              </button>
              <button class="btn btn-outline-primary btn-sm preset-url" onclick="setPresetUrl('1')">
                æ‘„åƒå¤´1
              </button>
              <button class="btn btn-outline-secondary btn-sm preset-url" onclick="setPresetUrl('rtsp://demo.com/stream')">
                RTSPç¤ºä¾‹
              </button>
            </div>
          </div>

          <!-- APIé…ç½® -->
          <div class="mb-3">
            <label for="apiKey" class="form-label">
              <i class="bi bi-key me-1"></i>API Key
            </label>
            <input type="password" class="form-control" id="apiKey"
                   placeholder="è¾“å…¥Qwen APIå¯†é’¥">
          </div>

          <!-- æ£€æµ‹å‚æ•° -->
          <div class="mb-3">
            <label for="confThreshold" class="form-label">
              ç½®ä¿¡åº¦é˜ˆå€¼: <span id="confValue">0.5</span>
            </label>
            <input type="range" class="form-range" id="confThreshold"
                   min="0.1" max="0.9" step="0.1" value="0.5">
          </div>

          <div class="row mb-3">
            <div class="col">
              <label for="detectionInterval" class="form-label">æ£€æµ‹é—´éš”</label>
              <select class="form-select" id="detectionInterval">
                <option value="10">æ¯10å¸§</option>
                <option value="30" selected>æ¯30å¸§</option>
                <option value="60">æ¯60å¸§</option>
                <option value="120">æ¯120å¸§</option>
              </select>
            </div>
            <div class="col">
              <label for="trackerType" class="form-label">è·Ÿè¸ªå™¨</label>
              <select class="form-select" id="trackerType">
                <option value="MIL" selected>MIL</option>
                <option value="CSRT">CSRT</option>
                <option value="KCF">KCF</option>
              </select>
            </div>
          </div>

          <!-- é«˜çº§é€‰é¡¹ -->
          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="enableAlerts">
              <label class="form-check-label" for="enableAlerts">
                å¯ç”¨å‘Šè­¦é€šçŸ¥
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="saveImages">
              <label class="form-check-label" for="saveImages">
                ä¿å­˜æ£€æµ‹å›¾åƒ
              </label>
            </div>
          </div>

          <!-- æ§åˆ¶æŒ‰é’® -->
          <div class="d-grid gap-2">
            <button class="btn btn-success" onclick="startTracking()" id="startBtn">
              <i class="bi bi-play-fill me-1"></i>å¼€å§‹è·Ÿè¸ª
            </button>
            <button class="btn btn-danger" onclick="stopTracking()" id="stopBtn" disabled>
              <i class="bi bi-stop-fill me-1"></i>åœæ­¢è·Ÿè¸ª
            </button>
          </div>

          <!-- æµçŠ¶æ€ -->
          <div class="mt-3 p-3 bg-light rounded" id="streamStatus">
            <h6 class="mb-2">
              <i class="bi bi-info-circle me-1"></i>çŠ¶æ€
            </h6>
            <div id="statusContent">
              <span class="status-indicator status-stopped"></span>
              æœªè¿æ¥
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- å³ä¾§è§†é¢‘é¢„è§ˆå’Œç»Ÿè®¡ -->
    <div class="col-md-8">
      <!-- è§†é¢‘é¢„è§ˆ -->
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">
            <i class="bi bi-camera me-2"></i>å®æ—¶é¢„è§ˆ
          </h5>
          <div class="btn-group btn-group-sm" role="group">
            <button type="button" class="btn btn-outline-primary" onclick="toggleFullscreen()" title="å…¨å±">
              <i class="bi bi-arrows-fullscreen"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="captureFrame()" title="æˆªå›¾">
              <i class="bi bi-camera"></i>
            </button>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="video-preview" id="videoPreview">
            <i class="bi bi-camera-video" style="font-size: 4rem; color: #6c757d;"></i>
            <p class="text-muted mt-2">é…ç½®è§†é¢‘æºå¹¶å¼€å§‹è·Ÿè¸ª</p>
          </div>
        </div>
      </div>

      <!-- ç»Ÿè®¡ä¿¡æ¯ -->
      <div class="card mb-3">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="bi bi-graph-up me-2"></i>æ£€æµ‹ç»Ÿè®¡
          </h5>
        </div>
        <div class="card-body">
          <div class="detection-stats" id="detectionStats">
            <div class="stat-card">
              <div class="stat-value" id="currentPersons">0</div>
              <div class="stat-label">å½“å‰äººæ•°</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="totalFrames">0</div>
              <div class="stat-label">å¤„ç†å¸§æ•°</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="totalDetections">0</div>
              <div class="stat-label">æ£€æµ‹æ¬¡æ•°</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="avgProcessTime">0</div>
              <div class="stat-label">å¹³å‡è€—æ—¶(ms)</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- æ—¥å¿—é¢æ¿ -->
  <div class="row mt-3">
    <div class="col">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">
            <i class="bi bi-terminal me-2"></i>å®æ—¶æ—¥å¿—
          </h5>
          <button class="btn btn-sm btn-outline-secondary" onclick="clearLogs()">
            <i class="bi bi-trash me-1"></i>æ¸…ç©ºæ—¥å¿—
          </button>
        </div>
        <div class="card-body p-0">
          <div class="log-container" id="logContainer">
            <!-- æ—¥å¿—å†…å®¹ -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // è§†é¢‘è·Ÿè¸ªç®¡ç†å™¨
  class VideoTrackingManager {
    constructor() {
      this.currentSessionId = null;
      this.eventSource = null;
      this.isTracking = false;
      this.stats = {
        currentPersons: 0,
        totalFrames: 0,
        totalDetections: 0,
        avgProcessTime: 0
      };
      this.logCount = 0;
      this.maxLogs = 100;

      this.initializeElements();
    }

    initializeElements() {
      // ç½®ä¿¡åº¦æ»‘å—
      const confThreshold = document.getElementById('confThreshold');
      const confValue = document.getElementById('confValue');

      confThreshold.addEventListener('input', (e) => {
        confValue.textContent = e.target.value;
      });
    }

    async startTracking() {
      const request = this.buildTrackingRequest();

      try {
        this.addLog('ğŸš€ å¯åŠ¨è§†é¢‘æµè·Ÿè¸ª...', 'info');
        this.updateStatus('connecting', 'è¿æ¥ä¸­...');

        const response = await fetch('/api/drone/stream/start', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(request)
        });

        const result = await response.json();

        if (result.success) {
          this.currentSessionId = result.sessionId;
          this.isTracking = true;

          this.addLog(`âœ… è·Ÿè¸ªä¼šè¯å·²åˆ›å»º: ${this.currentSessionId}`, 'success');
          this.updateStatus('active', 'è·Ÿè¸ªä¸­...');
          this.updateControls(true);

          // å¯åŠ¨ç»“æœç›‘å¬
          this.startResultListener();

          // å¯åŠ¨è§†é¢‘æµæ˜¾ç¤º
          this.startVideoStream();

        } else {
          throw new Error(result.error || 'å¯åŠ¨å¤±è´¥');
        }

      } catch (error) {
        this.addLog(`âŒ å¯åŠ¨å¤±è´¥: ${error.message}`, 'error');
        this.updateStatus('error', 'è¿æ¥å¤±è´¥');
        this.updateControls(false);
      }
    }

    async stopTracking() {
      if (!this.currentSessionId) return;

      try {
        this.addLog('ğŸ›‘ åœæ­¢è§†é¢‘æµè·Ÿè¸ª...', 'info');

        const response = await fetch(`/api/drone/stream/stop/${this.currentSessionId}`, {
          method: 'POST'
        });

        const result = await response.json();

        if (result.success) {
          this.addLog('âœ… è·Ÿè¸ªå·²åœæ­¢', 'success');
        }

      } catch (error) {
        this.addLog(`âŒ åœæ­¢å¤±è´¥: ${error.message}`, 'error');
      } finally {
        this.cleanup();
      }
    }

    startResultListener() {
      if (!this.currentSessionId) return;

      this.eventSource = new EventSource(`/api/drone/stream/results/${this.currentSessionId}`);

      this.eventSource.onmessage = (event) => {
        try {
          const result = JSON.parse(event.data);
          this.handleTrackingResult(result);
        } catch (error) {
          console.error('è§£æè·Ÿè¸ªç»“æœå¤±è´¥:', error);
          this.addLog(`âš ï¸ è§£æç»“æœå¤±è´¥: ${error.message}`, 'warning');
        }
      };

      this.eventSource.onerror = (error) => {
        console.error('EventSourceé”™è¯¯:', error);
        this.addLog('âŒ è¿æ¥ä¸­æ–­ï¼Œå°è¯•é‡è¿...', 'error');
        this.updateStatus('error', 'è¿æ¥ä¸­æ–­');

        // å°è¯•é‡è¿
        setTimeout(() => {
          if (this.isTracking) {
            this.startResultListener();
          }
        }, 5000);
      };

      this.addLog('ğŸ“¡ å¼€å§‹æ¥æ”¶å®æ—¶ç»“æœ...', 'info');
    }

    startVideoStream() {
      if (!this.currentSessionId) return;

      const videoPreview = document.getElementById('videoPreview');

      // åˆ›å»ºimgå…ƒç´ æ˜¾ç¤ºMJPEGæµ
      const img = document.createElement('img');
      img.className = 'video-stream';
      img.src = `/api/drone/stream/frames/${this.currentSessionId}`;
      img.alt = 'å®æ—¶è§†é¢‘æµ';

      img.onload = () => {
        videoPreview.innerHTML = '';

        const overlay = document.createElement('div');
        overlay.className = 'detection-overlay';
        overlay.appendChild(img);

        const info = document.createElement('div');
        info.className = 'detection-info';
        info.id = 'detectionInfo';
        info.innerHTML = 'ç­‰å¾…æ£€æµ‹ç»“æœ...';
        overlay.appendChild(info);

        videoPreview.appendChild(overlay);
        videoPreview.classList.add('active');
      };

      img.onerror = () => {
        this.addLog('âŒ è§†é¢‘æµåŠ è½½å¤±è´¥', 'error');
        videoPreview.innerHTML = `
                        <i class="bi bi-exclamation-triangle" style="font-size: 3rem; color: #dc3545;"></i>
                        <p class="text-danger mt-2">è§†é¢‘æµåŠ è½½å¤±è´¥</p>
                    `;
      };
    }

    handleTrackingResult(result) {
      // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
      this.stats.currentPersons = result.currentPersonCount || 0;
      this.stats.totalFrames = result.frameNumber || 0;
      this.stats.totalDetections = result.totalDetections || 0;

      if (result.processingTimeMs) {
        // è®¡ç®—å¹³å‡å¤„ç†æ—¶é—´
        const currentAvg = this.stats.avgProcessTime;
        this.stats.avgProcessTime = currentAvg === 0 ?
                result.processingTimeMs :
                Math.round((currentAvg + result.processingTimeMs) / 2);
      }

      this.updateStatsDisplay();

      // æ›´æ–°æ£€æµ‹ä¿¡æ¯è¦†ç›–å±‚
      this.updateDetectionOverlay(result);

      // è®°å½•æ£€æµ‹æ—¥å¿—
      if (result.currentPersonCount > 0) {
        this.addLog(`ğŸ¯ æ£€æµ‹åˆ°${result.currentPersonCount}ä¸ªç›®æ ‡ [å¸§${result.frameNumber}]`, 'success');
      }

      // æ£€æŸ¥å‘Šè­¦
      if (result.alertTriggered && result.alertMessage) {
        this.addLog(`ğŸš¨ å‘Šè­¦: ${result.alertMessage}`, 'warning');
        this.showAlert(result.alertMessage);
      }
    }

    updateDetectionOverlay(result) {
      const detectionInfo = document.getElementById('detectionInfo');
      if (!detectionInfo) return;

      const timestamp = new Date(result.timestamp).toLocaleTimeString();
      let info = `
                    <strong>å¸§ ${result.frameNumber}</strong><br>
                    <i class="bi bi-people me-1"></i>${result.currentPersonCount}äºº<br>
                    <i class="bi bi-clock me-1"></i>${timestamp}<br>
                    <i class="bi bi-speedometer me-1"></i>${result.processingTimeMs}ms
                `;

      if (result.detections && result.detections.length > 0) {
        info += '<br><small>';
        result.detections.forEach(detection => {
          info += `ID${detection.trackerId}(${(detection.confidence * 100).toFixed(1)}%) `;
        });
        info += '</small>';
      }

      detectionInfo.innerHTML = info;
    }

    updateStatsDisplay() {
      document.getElementById('currentPersons').textContent = this.stats.currentPersons;
      document.getElementById('totalFrames').textContent = this.stats.totalFrames;
      document.getElementById('totalDetections').textContent = this.stats.totalDetections;
      document.getElementById('avgProcessTime').textContent = this.stats.avgProcessTime;
    }

    buildTrackingRequest() {
      return {
        streamUrl: document.getElementById('streamUrl').value.trim(),
        apiKey: document.getElementById('apiKey').value.trim(),
        confThreshold: parseFloat(document.getElementById('confThreshold').value),
        detectionInterval: parseInt(document.getElementById('detectionInterval').value),
        trackerType: document.getElementById('trackerType').value,
        enableAlerts: document.getElementById('enableAlerts').checked,
        saveImages: document.getElementById('saveImages').checked,
        maxDetections: 200,
        description: `è§†é¢‘æµè·Ÿè¸ª - ${new Date().toLocaleString()}`
      };
    }

    updateStatus(status, message) {
      const statusContent = document.getElementById('statusContent');
      const statusClasses = ['status-stopped', 'status-connecting', 'status-active', 'status-error'];

      statusContent.innerHTML = `
                    <span class="status-indicator ${statusClasses.find(cls => cls.includes(status)) || 'status-stopped'}"></span>
                    ${message}
                `;

      if (this.currentSessionId) {
        statusContent.innerHTML += `<br><small class="text-muted">ä¼šè¯: ${this.currentSessionId}</small>`;
      }
    }

    updateControls(isTracking) {
      document.getElementById('startBtn').disabled = isTracking;
      document.getElementById('stopBtn').disabled = !isTracking;

      // ç¦ç”¨/å¯ç”¨é…ç½®æ§ä»¶
      const controls = ['streamUrl', 'apiKey', 'confThreshold', 'detectionInterval', 'trackerType'];
      controls.forEach(id => {
        document.getElementById(id).disabled = isTracking;
      });
    }

    cleanup() {
      this.isTracking = false;
      this.currentSessionId = null;

      if (this.eventSource) {
        this.eventSource.close();
        this.eventSource = null;
      }

      this.updateStatus('stopped', 'å·²åœæ­¢');
      this.updateControls(false);

      // æ¸…ç©ºè§†é¢‘é¢„è§ˆ
      const videoPreview = document.getElementById('videoPreview');
      videoPreview.classList.remove('active');
      videoPreview.innerHTML = `
                    <i class="bi bi-camera-video" style="font-size: 4rem; color: #6c757d;"></i>
                    <p class="text-muted mt-2">é…ç½®è§†é¢‘æºå¹¶å¼€å§‹è·Ÿè¸ª</p>
                `;
    }

    addLog(message, type = 'info') {
      const logContainer = document.getElementById('logContainer');
      const timestamp = new Date().toLocaleTimeString();

      const logEntry = document.createElement('div');
      logEntry.className = `log-entry log-${type}`;
      logEntry.innerHTML = `<span class="text-muted">[${timestamp}]</span> ${message}`;

      logContainer.insertBefore(logEntry, logContainer.firstChild);

      // é™åˆ¶æ—¥å¿—æ•°é‡
      this.logCount++;
      if (this.logCount > this.maxLogs) {
        const lastEntry = logContainer.lastElementChild;
        if (lastEntry) {
          lastEntry.remove();
          this.logCount--;
        }
      }
    }

    showAlert(message) {
      // ç®€å•çš„æµè§ˆå™¨é€šçŸ¥
      if (Notification.permission === 'granted') {
        new Notification('æ£€æµ‹å‘Šè­¦', {
          body: message,
          icon: '/favicon.ico'
        });
      }

      // é¡µé¢å†…å‘Šè­¦
      const alert = document.createElement('div');
      alert.className = 'alert alert-warning alert-dismissible fade show position-fixed';
      alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
      alert.innerHTML = `
                    <i class="bi bi-exclamation-triangle me-2"></i>${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;

      document.body.appendChild(alert);

      // è‡ªåŠ¨ç§»é™¤
      setTimeout(() => {
        if (alert.parentNode) {
          alert.remove();
        }
      }, 5000);
    }
  }

  // å…¨å±€å˜é‡å’Œå‡½æ•°
  let trackingManager;

  // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', function() {
    trackingManager = new VideoTrackingManager();

    // è¯·æ±‚é€šçŸ¥æƒé™
    if (Notification.permission === 'default') {
      Notification.requestPermission();
    }
  });

  // å…¨å±€å‡½æ•°
  function startTracking() {
    // éªŒè¯è¾“å…¥
    const streamUrl = document.getElementById('streamUrl').value.trim();
    const apiKey = document.getElementById('apiKey').value.trim();

    if (!streamUrl) {
      alert('è¯·è¾“å…¥è§†é¢‘æºåœ°å€æˆ–æ‘„åƒå¤´ID');
      return;
    }

    if (!apiKey) {
      alert('è¯·è¾“å…¥API Key');
      return;
    }

    trackingManager.startTracking();
  }

  function stopTracking() {
    trackingManager.stopTracking();
  }

  function setPresetUrl(url) {
    document.getElementById('streamUrl').value = url;
  }

  function clearLogs() {
    document.getElementById('logContainer').innerHTML = '';
    trackingManager.logCount = 0;
  }

  function toggleFullscreen() {
    const videoPreview = document.getElementById('videoPreview');

    if (document.fullscreenElement) {
      document.exitFullscreen();
    } else {
      videoPreview.requestFullscreen().catch(err => {
        console.error('å…¨å±å¤±è´¥:', err);
      });
    }
  }

  function captureFrame() {
    const img = document.querySelector('.video-stream');
    if (!img) {
      alert('å½“å‰æ²¡æœ‰è§†é¢‘æµ');
      return;
    }

    // åˆ›å»ºcanvasæˆªå›¾
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    canvas.width = img.naturalWidth || img.width;
    canvas.height = img.naturalHeight || img.height;

    ctx.drawImage(img, 0, 0);

    // ä¸‹è½½æˆªå›¾
    const link = document.createElement('a');
    link.download = `capture_${new Date().getTime()}.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();

    trackingManager.addLog('ğŸ“¸ å·²ä¿å­˜æˆªå›¾', 'success');
  }

  function goBack() {
    window.location.href = '/';
  }

  // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
  window.addEventListener('beforeunload', function() {
    if (trackingManager && trackingManager.isTracking) {
      trackingManager.stopTracking();
    }
  });
</script>
</body>
</html>